<!DOCTYPE html>
<html>

<head>
  <title>frontend</title>
  <script>
    const stack = [];

    function get_stack_str(results) {
      const [pointer, len] = [stack.pop(), stack.pop()];
      const buffer = new Uint8Array(
        results.exports.memory.buffer,
        pointer,
        len
      );
      const str = String.fromCharCode(...buffer);
      results.exports.dealloc_str(pointer);
      return str;
    }

    function create_rust_string(str, results) {
      const encoder = new TextEncoder();
      let encoded_str = encoder.encode(str);

      const string_ptr = results.exports.alloc_rust_string(encoded_str.length);
      const string_mem = results.exports.get_rust_string_ptr(string_ptr);

      const asBytes = new Uint8Array(results.exports.memory.buffer, string_mem, encoded_str.length);
      asBytes.set(encoded_str);
      return string_ptr;
    }

    var wasm;
    var wasm_file = location.origin + '/target/wasm32-unknown-unknown//release/web_frontend.wasm';
    fetch(wasm_file).then(response =>
      response.arrayBuffer()
    ).then(bytes =>
      WebAssembly.instantiate(bytes, {
        env: {
          stack_push: (val) => stack.push(val),
        }
      })
    ).then(results => {
      wasm = results.instance;
    });

    window.onload = function() {
      document.getElementById("solve_button").onclick = function() {
        let scramble = create_rust_string(document.getElementById("scramble").value, wasm);
        console.time("solve_fb");
        wasm.exports.solve_fb(scramble);
        console.timeEnd("solve_fb");
        wasm.exports.dealloc_rust_string(scramble);
        const solutions = JSON.parse(get_stack_str(wasm));
        let inner = document.createElement("div");
        solutions.forEach(s => {
          let d = document.createElement("div");
          d.textContent = s;
          inner.appendChild(d);
        });
        const results = document.getElementById("results");
        results.replaceChild(inner, results.children[0]);
      }
    }
  </script>
</head>

<body>
<input type="text" size="100" id="scramble"></input>
<input type="button" value="Solve" id="solve_button"></input>
<div id="results"><div></div></div>
</body>

</html>
